# =============================================================================
# PLCOpen 嵌入式运行时 - 开发环境 Dockerfile
# =============================================================================
# 使用阿里云镜像加速
# 构建: docker build -f docker/Dockerfile.dev -t plcopen-dev .
# =============================================================================

FROM python:3.11-slim

LABEL maintainer="Hollysys <dev@hollysys.com>"
LABEL description="PLCOpen嵌入式运行时开发环境"

# 配置阿里云镜像源
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources && \
    sed -i 's/security.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources

# 安装系统依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    cmake \
    git \
    gdb \
    && rm -rf /var/lib/apt/lists/*

# 配置pip阿里云镜像
RUN pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/ && \
    pip config set install.trusted-host mirrors.aliyun.com

# 设置工作目录
WORKDIR /app

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制项目文件
COPY . .

# 构建C扩展
RUN mkdir -p build && cd build && \
    cmake .. -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=ON && \
    make -j$(nproc)

# 设置环境变量
ENV PYTHONPATH=/app:/app/build
ENV PYTHONUNBUFFERED=1
ENV PLCOPEN_SCRIPT_DIR=/app/scripts
ENV PLCOPEN_LOG_DIR=/app/logs
ENV PLCOPEN_DEBUG_ENABLED=true
ENV PLCOPEN_DEBUG_PORT=5678

# 暴露调试端口
EXPOSE 5678

# 创建必要目录
RUN mkdir -p /app/scripts /app/logs

# 默认命令
CMD ["python", "-m", "runtime.main"]
